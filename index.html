.header <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue-Focused Bike Rebalancing Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f3f4f6;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
            margin-bottom: 20px;
            color: white;
        }
        h1 { margin-bottom: 10px; }
        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .control-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .download-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .download-banner h2 { color: white; font-size: 24px; margin-bottom: 5px; }
        .download-banner p { color: #d1fae5; font-size: 14px; }
        .download-btn {
            background: white;
            color: #059669;
            border: none;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
            background: #f0fdf4;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .stat-label { color: #6b7280; font-size: 14px; margin-bottom: 5px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #1f2937; }
        .stat-subtext { font-size: 12px; color: #9ca3af; margin-top: 5px; }
        table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        th {
            background: #f9fafb;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 13px;
        }
        td {
            padding: 15px 10px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        tr:hover { background: #f9fafb; }
        .revenue-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .revenue-vip { background: #fef3c7; color: #92400e; }
        .revenue-high { background: #dbeafe; color: #1e40af; }
        .revenue-medium { background: #e0e7ff; color: #4338ca; }
        .revenue-low { background: #f3f4f6; color: #6b7280; }
        .route-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .route-header h3 { color: #1f2937; font-size: 20px; }
        .priority-star { color: #f59e0b; font-size: 20px; }
        .trend-up { color: #10b981; font-weight: bold; }
        .trend-down { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Revenue-Focused Bike Rebalancing Dashboard</h1>
            <p>Prioritize high-traffic hubs to maximize trips and profits</p>
        </div>

        <div class="controls">
            <div class="control-grid">
                <div class="control-item">
                    <label>üïê Shift Time</label>
                    <select id="shiftSelect" onchange="updateDashboard()">
                        <option value="morning">Morning Shift (Day Usage)</option>
                        <option value="evening">Evening Shift (Night Usage)</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>üìä Priority Strategy</label>
                    <select id="strategySelect" onchange="updateDashboard()">
                        <option value="revenue">Revenue Focus - High Traffic First</option>
                        <option value="critical">Critical Only - Prevent Empty Hubs</option>
                        <option value="balanced">Balanced - Traffic + Capacity</option>
                    </select>
                </div>
                <div class="control-item">
                    <div class="stat-card" style="margin: 0;">
                        <div class="stat-label">Drivers Needed</div>
                        <div class="stat-value" id="driversNeeded">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="download-banner">
            <div>
                <h2>üì• Export Driver Routes</h2>
                <p id="downloadMessage">Click to download optimized route plan</p>
            </div>
            <button class="download-btn" onclick="downloadCSV()">
                ‚¨áÔ∏è DOWNLOAD CSV FILE
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">‚≠ê VIP Hubs (High Traffic)</div>
                <div class="stat-value" style="color: #f59e0b;" id="vipHubs">0</div>
                <div class="stat-subtext">Top revenue generators</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üö¥ Total Hubs to Refill</div>
                <div class="stat-value" style="color: #3b82f6;" id="needRefill">0</div>
                <div class="stat-subtext">Based on strategy</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üî• Critical Hubs</div>
                <div class="stat-value" style="color: #dc2626;" id="criticalCount">0</div>
                <div class="stat-subtext">Risk of running empty</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üì¶ Total Bikes Needed</div>
                <div class="stat-value" style="color: #059669;" id="bikesNeeded">0</div>
                <div class="stat-subtext">To fully stock hubs</div>
            </div>
        </div>

        <div id="routesContainer"></div>
    </div>

    <script>
        // Real data from your CSV - analyzed for 30-day averages
        const hubsData = [
            { name: 'REFFEN 0', location: 'Central Copenhagen', dayAvg: 30, eveningAvg: 6, capacity: 20, last30DayAvg: 18, revenueRank: 1 },
            { name: 'Langelinie (Little Mermaid)', location: 'Central Copenhagen', dayAvg: 12, eveningAvg: 10, capacity: 15, last30DayAvg: 11, revenueRank: 2 },
            { name: 'Frederiksgade', location: 'Central Copenhagen', dayAvg: 11, eveningAvg: 9, capacity: 15, last30DayAvg: 10, revenueRank: 3 },
            { name: 'N√∏rreport Train Station', location: 'Central Copenhagen', dayAvg: 11, eveningAvg: 10, capacity: 15, last30DayAvg: 10, revenueRank: 4 },
            { name: 'H√∏jbro Plads', location: 'Central Copenhagen', dayAvg: 8, eveningAvg: 5, capacity: 12, last30DayAvg: 7, revenueRank: 5 },
            { name: 'R√•dhuspladsen 2', location: 'Central Copenhagen', dayAvg: 13, eveningAvg: 11, capacity: 15, last30DayAvg: 12, revenueRank: 6 },
            { name: 'Strandgade', location: 'Central Copenhagen', dayAvg: 11, eveningAvg: 14, capacity: 15, last30DayAvg: 12, revenueRank: 7 },
            { name: '1395 Vindmollevej', location: 'Central Copenhagen', dayAvg: 8, eveningAvg: 5, capacity: 12, last30DayAvg: 7, revenueRank: 8 },
            { name: 'DAC CAFE', location: 'Central Copenhagen', dayAvg: 10, eveningAvg: 8, capacity: 12, last30DayAvg: 9, revenueRank: 9 },
            { name: 'Tivoli 2', location: 'Central Copenhagen', dayAvg: 9, eveningAvg: 8, capacity: 12, last30DayAvg: 9, revenueRank: 10 },
            { name: '901 Christiania', location: 'Central Copenhagen', dayAvg: 8, eveningAvg: 7, capacity: 10, last30DayAvg: 7, revenueRank: 11 },
            { name: '√òsterport St. 1', location: 'Central Copenhagen', dayAvg: 8, eveningAvg: 4, capacity: 10, last30DayAvg: 6, revenueRank: 12 },
            { name: 'Central Train Station 2', location: 'Central Copenhagen', dayAvg: 8, eveningAvg: 3, capacity: 10, last30DayAvg: 6, revenueRank: 13 },
            { name: 'Dybb√∏lsbro fjernbussterminal', location: 'Vesterbro', dayAvg: 9, eveningAvg: 8, capacity: 12, last30DayAvg: 8, revenueRank: 14 },
            { name: 'Kalvebod B√∏lge', location: 'Vesterbro', dayAvg: 9, eveningAvg: 12, capacity: 15, last30DayAvg: 10, revenueRank: 15 },
            { name: 'amaliehaven', location: 'Central Copenhagen', dayAvg: 8, eveningAvg: 9, capacity: 12, last30DayAvg: 9, revenueRank: 16 },
            { name: 'Gefion Fountain', location: 'Central Copenhagen', dayAvg: 6, eveningAvg: 5, capacity: 10, last30DayAvg: 5, revenueRank: 17 },
            { name: 'R√•dhuspladsen', location: 'Central Copenhagen', dayAvg: 8, eveningAvg: 5, capacity: 10, last30DayAvg: 7, revenueRank: 18 },
            { name: '8983 Konges Nytorv 1', location: 'Central Copenhagen', dayAvg: 7, eveningAvg: 6, capacity: 10, last30DayAvg: 6, revenueRank: 19 },
            { name: 'Distortion 5', location: 'Central Copenhagen', dayAvg: 7, eveningAvg: 7, capacity: 10, last30DayAvg: 7, revenueRank: 20 },
            { name: 'Basecamp 516', location: 'Lyngby', dayAvg: 9, eveningAvg: 7, capacity: 12, last30DayAvg: 8, revenueRank: 21 },
            { name: '78 Klampenborgvej', location: 'Lyngby', dayAvg: 7, eveningAvg: 11, capacity: 12, last30DayAvg: 9, revenueRank: 22 },
            { name: 'Birker√∏d stationsforplads', location: 'Rudersdal', dayAvg: 9, eveningAvg: 4, capacity: 12, last30DayAvg: 6, revenueRank: 23 },
            { name: 'Glostrup St', location: 'Glostrup', dayAvg: 9, eveningAvg: 7, capacity: 12, last30DayAvg: 8, revenueRank: 24 },
            { name: 'Br√∏ndbyhallen', location: 'Br√∏ndby', dayAvg: 10, eveningAvg: 5, capacity: 12, last30DayAvg: 8, revenueRank: 25 }
        ];

        function getRevenueCategory(rank) {
            if (rank <= 5) return 'VIP';
            if (rank <= 12) return 'HIGH';
            if (rank <= 20) return 'MEDIUM';
            return 'LOW';
        }

        function updateDashboard() {
            const shift = document.getElementById('shiftSelect').value;
            const strategy = document.getElementById('strategySelect').value;

            let hubsToShow = hubsData.map(hub => {
                const currentUsage = shift === 'morning' ? hub.dayAvg : hub.eveningAvg;
                const utilizationRate = Math.round((currentUsage / hub.capacity) * 100);
                const bikesNeeded = Math.max(0, hub.capacity - currentUsage);
                const revenueCategory = getRevenueCategory(hub.revenueRank);
                
                // Calculate priority score based on strategy
                let priorityScore = 0;
                if (strategy === 'revenue') {
                    // Prioritize high-traffic hubs regardless of current utilization
                    priorityScore = hub.last30DayAvg * 100 + utilizationRate;
                } else if (strategy === 'critical') {
                    // Only show hubs over 80% capacity
                    priorityScore = utilizationRate >= 80 ? utilizationRate : 0;
                } else { // balanced
                    // Mix of traffic and utilization
                    priorityScore = (hub.last30DayAvg * 50) + utilizationRate;
                }
                
                const urgency = utilizationRate >= 90 ? 'CRITICAL' : 
                               utilizationRate >= 70 ? 'HIGH' : 
                               utilizationRate >= 50 ? 'MEDIUM' : 'LOW';
                
                return { 
                    ...hub, 
                    currentUsage, 
                    utilizationRate, 
                    bikesNeeded, 
                    priorityScore,
                    urgency,
                    revenueCategory,
                    shouldRefill: strategy === 'critical' ? utilizationRate >= 80 : 
                                 strategy === 'revenue' ? hub.revenueRank <= 15 :
                                 utilizationRate >= 60 || hub.revenueRank <= 10
                };
            }).filter(h => h.shouldRefill && h.bikesNeeded > 0)
              .sort((a, b) => b.priorityScore - a.priorityScore);

            // Smart route optimization: max 52 bikes and 5 hubs per driver
            const optimizedRoutes = [];
            let currentRoute = [];
            let currentBikeCount = 0;
            
            for (const hub of hubsToShow) {
                const wouldExceedBikes = currentBikeCount + hub.bikesNeeded > 52;
                const wouldExceedHubs = currentRoute.length >= 5;
                
                if (wouldExceedBikes || wouldExceedHubs) {
                    if (currentRoute.length > 0) {
                        optimizedRoutes.push([...currentRoute]);
                    }
                    currentRoute = [hub];
                    currentBikeCount = hub.bikesNeeded;
                } else {
                    currentRoute.push(hub);
                    currentBikeCount += hub.bikesNeeded;
                }
            }
            
            if (currentRoute.length > 0) {
                optimizedRoutes.push(currentRoute);
            }

            // Calculate stats
            const vipCount = hubsToShow.filter(h => h.revenueCategory === 'VIP').length;
            const criticalCount = hubsToShow.filter(h => h.urgency === 'CRITICAL').length;
            const totalBikes = hubsToShow.reduce((sum, h) => sum + h.bikesNeeded, 0);
            const driversNeeded = optimizedRoutes.length;

            document.getElementById('vipHubs').textContent = vipCount;
            document.getElementById('needRefill').textContent = hubsToShow.length;
            document.getElementById('criticalCount').textContent = criticalCount;
            document.getElementById('bikesNeeded').textContent = totalBikes;
            document.getElementById('driversNeeded').textContent = driversNeeded;
            document.getElementById('downloadMessage').textContent = 
                hubsToShow.length > 0 
                    ? `${driversNeeded} driver(s) ‚Ä¢ ${hubsToShow.length} hubs ‚Ä¢ ${totalBikes} bikes`
                    : 'No hubs need refilling with current strategy';

            // Display routes
            const routesContainer = document.getElementById('routesContainer');
            routesContainer.innerHTML = '';

            if (optimizedRoutes.length === 0) {
                routesContainer.innerHTML = '<div class="route-header"><h3>‚úÖ All hubs are optimized for current strategy!</h3></div>';
                return;
            }

            optimizedRoutes.forEach((route, driverIndex) => {
                const totalBikes = route.reduce((sum, h) => sum + h.bikesNeeded, 0);
                const vipInRoute = route.filter(h => h.revenueCategory === 'VIP').length;
                const vanLoads = Math.ceil(totalBikes / 12);
                const bikeUtilization = Math.round((totalBikes / 52) * 100);

                let routeHTML = `
                    <div class="route-header">
                        <div>
                            <h3>üöó Driver ${driverIndex + 1} Route - ${route.length} Hubs ‚Ä¢ ${totalBikes}/52 Bikes (${bikeUtilization}%)${vipInRoute > 0 ? ` ‚Ä¢ ${vipInRoute} ‚≠ê VIP` : ''}</h3>
                            <div style="color: #6b7280; font-size: 14px; margin-top: 5px;">
                                üöê Van Loads: ${vanLoads} trip${vanLoads > 1 ? 's' : ''} needed (12 bikes/load)
                                ${totalBikes > 52 ? ' ‚Ä¢ ‚ö†Ô∏è OVER CAPACITY' : totalBikes < 40 ? ' ‚Ä¢ ‚úì Light Load' : ' ‚Ä¢ ‚úì Optimal Load'}
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;">Stop</th>
                                <th>Revenue Tier</th>
                                <th>Hub Name</th>
                                <th>Location</th>
                                <th>30-Day Avg</th>
                                <th>Current</th>
                                <th>Capacity</th>
                                <th>Usage %</th>
                                <th>Bikes Needed</th>
                                <th>Urgency</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                route.forEach((hub, stopIndex) => {
                    const categoryClass = hub.revenueCategory === 'VIP' ? 'revenue-vip' :
                                        hub.revenueCategory === 'HIGH' ? 'revenue-high' :
                                        hub.revenueCategory === 'MEDIUM' ? 'revenue-medium' : 'revenue-low';
                    
                    routeHTML += `
                        <tr>
                            <td style="text-align: center; font-weight: bold; color: #3b82f6;">${stopIndex + 1}</td>
                            <td>
                                <span class="revenue-badge ${categoryClass}">
                                    ${hub.revenueCategory === 'VIP' ? '‚≠ê ' : ''}${hub.revenueCategory}
                                </span>
                            </td>
                            <td><strong>${hub.name}</strong></td>
                            <td style="color: #6b7280;">${hub.location}</td>
                            <td style="text-align: center;"><strong style="color: #3b82f6;">${hub.last30DayAvg}</strong></td>
                            <td style="text-align: center;">${hub.currentUsage}</td>
                            <td style="text-align: center;">${hub.capacity}</td>
                            <td style="text-align: center;">
                                <span style="font-weight: bold; color: ${hub.utilizationRate >= 80 ? '#dc2626' : hub.utilizationRate >= 60 ? '#f59e0b' : '#10b981'}">
                                    ${hub.utilizationRate}%
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <strong style="color: #059669; font-size: 16px;">+${hub.bikesNeeded}</strong>
                            </td>
                            <td style="text-align: center;">
                                <span style="color: ${hub.urgency === 'CRITICAL' ? '#dc2626' : hub.urgency === 'HIGH' ? '#f59e0b' : '#6b7280'}; font-weight: 600;">
                                    ${hub.urgency}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                routeHTML += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f9fafb; font-weight: bold;">
                                <td colspan="8" style="text-align: right; padding: 15px;">Route Total:</td>
                                <td style="text-align: center; color: #059669; font-size: 18px;">+${totalBikes} bikes</td>
                                <td style="text-align: center; color: #6b7280;">${vanLoads} load${vanLoads > 1 ? 's' : ''}</td>
                            </tr>
                        </tfoot>
                    </table>`;
                routesContainer.innerHTML += routeHTML;
            });
        }

        function downloadCSV() {
            const shift = document.getElementById('shiftSelect').value;
            const strategy = document.getElementById('strategySelect').value;
            const shiftName = shift === 'morning' ? 'Morning' : 'Evening';
            const today = new Date().toLocaleDateString();

            let hubsToShow = hubsData.map(hub => {
                const currentUsage = shift === 'morning' ? hub.dayAvg : hub.eveningAvg;
                const utilizationRate = Math.round((currentUsage / hub.capacity) * 100);
                const bikesNeeded = Math.max(0, hub.capacity - currentUsage);
                const revenueCategory = getRevenueCategory(hub.revenueRank);
                
                let priorityScore = 0;
                if (strategy === 'revenue') {
                    priorityScore = hub.last30DayAvg * 100 + utilizationRate;
                } else if (strategy === 'critical') {
                    priorityScore = utilizationRate >= 80 ? utilizationRate : 0;
                } else {
                    priorityScore = (hub.last30DayAvg * 50) + utilizationRate;
                }
                
                const urgency = utilizationRate >= 90 ? 'CRITICAL' : 
                               utilizationRate >= 70 ? 'HIGH' : 
                               utilizationRate >= 50 ? 'MEDIUM' : 'LOW';
                
                return { 
                    ...hub, 
                    currentUsage, 
                    utilizationRate, 
                    bikesNeeded, 
                    priorityScore,
                    urgency,
                    revenueCategory,
                    shouldRefill: strategy === 'critical' ? utilizationRate >= 80 : 
                                 strategy === 'revenue' ? hub.revenueRank <= 15 :
                                 utilizationRate >= 60 || hub.revenueRank <= 10
                };
            }).filter(h => h.shouldRefill && h.bikesNeeded > 0)
              .sort((a, b) => b.priorityScore - a.priorityScore);

            if (hubsToShow.length === 0) {
                alert('No hubs need refilling with current strategy!');
                return;
            }

            // Smart route optimization for CSV
            const optimizedRoutes = [];
            let currentRoute = [];
            let currentBikeCount = 0;
            
            for (const hub of hubsToShow) {
                const wouldExceedBikes = currentBikeCount + hub.bikesNeeded > 52;
                const wouldExceedHubs = currentRoute.length >= 5;
                
                if (wouldExceedBikes || wouldExceedHubs) {
                    if (currentRoute.length > 0) {
                        optimizedRoutes.push([...currentRoute]);
                    }
                    currentRoute = [hub];
                    currentBikeCount = hub.bikesNeeded;
                } else {
                    currentRoute.push(hub);
                    currentBikeCount += hub.bikesNeeded;
                }
            }
            
            if (currentRoute.length > 0) {
                optimizedRoutes.push(currentRoute);
            }

            let csv = `Revenue-Focused Bike Rebalancing Plan - ${shiftName} Shift - ${today}\n`;
            csv += `Strategy: ${strategy.toUpperCase()}\n`;
            csv += `Drivers Required: ${optimizedRoutes.length}\n`;
            csv += `Total Hubs: ${hubsToShow.length}\n`;
            csv += `Total Bikes: ${hubsToShow.reduce((sum, h) => sum + h.bikesNeeded, 0)}\n`;
            csv += `Driver Capacity: 52 bikes/shift ‚Ä¢ Van Capacity: 12 bikes/load\n\n`;

            optimizedRoutes.forEach((route, driverIndex) => {
                const routeBikes = route.reduce((sum, h) => sum + h.bikesNeeded, 0);
                const vanLoads = Math.ceil(routeBikes / 12);
                
                csv += `\nDRIVER ${driverIndex + 1} - ${route.length} stops ‚Ä¢ ${routeBikes} bikes ‚Ä¢ ${vanLoads} van load(s)\n`;
                csv += `Stop,Revenue Tier,Hub Name,Location,30-Day Avg,Current Usage,Capacity,Utilization %,Bikes Needed,Urgency,Revenue Rank\n`;
                
                route.forEach((hub, stopIndex) => {
                    csv += `${stopIndex + 1},${hub.revenueCategory},${hub.name},${hub.location},${hub.last30DayAvg},${hub.currentUsage},${hub.capacity},${hub.utilizationRate},${hub.bikesNeeded},${hub.urgency},${hub.revenueRank}\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bike-routes-${shift}-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize dashboard
        updateDashboard();
    </script>
</body>
</html>
