<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue-Focused Bike Rebalancing Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f3f4f6;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #clock {
            font-size: 26px;
            font-weight: bold;
            color: red;
        }

        #csvDropzone {
            border: 3px dashed #6b7280;
            padding: 30px;
            text-align: center;
            color: #374151;
            font-size: 18px;
            border-radius: 12px;
            background: white;
            margin-bottom: 20px;
            transition: 0.3s;
        }
        #csvDropzone.dragover {
            border-color: #10b981;
            background: #ecfdf5;
            color: #065f46;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .revenue-badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold; 
        }

        .route-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .under { color: #d97706; font-weight: bold; }
        .over { color: #dc2626; font-weight: bold; }

    </style>
</head>
<body>
    <div class="container">

        <!-- HEADER WITH CLOCK -->
        <div class="header">
            <div>
                <h1>üí∞ Revenue-Focused Bike Rebalancing Dashboard</h1>
                <p>Prioritize high-traffic hubs to maximize trips and profits</p>
            </div>
            <div id="clock">00:00</div>
        </div>

        <!-- CSV DROPZONE -->
        <div id="csvDropzone">üìÇ Drag & Drop CSV Here<br><small>(or click to select)</small></div>
        <input type="file" id="csvInput" accept=".csv" style="display:none;">

        <!-- CONTROLS -->
        <div class="controls">
            <div class="control-grid">
                <div>
                    <label>üïê Shift Time</label>
                    <select id="shiftSelect" onchange="updateDashboard()">
                        <option value="morning">Morning Shift</option>
                        <option value="evening">Evening Shift</option>
                    </select>
                </div>
                <div>
                    <label>üìä Priority Strategy</label>
                    <select id="strategySelect" onchange="updateDashboard()">
                        <option value="revenue">Revenue Focus</option>
                        <option value="critical">Critical First</option>
                        <option value="balanced">Balanced</option>
                    </select>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Drivers Needed</div>
                    <div class="stat-value" id="driversNeeded">0</div>
                </div>
            </div>
        </div>

        <!-- STAT CARDS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">‚≠ê VIP Hubs</div>
                <div class="stat-value" id="vipHubs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üö¥ Total Hubs</div>
                <div class="stat-value" id="needRefill">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üî• Critical Hubs</div>
                <div class="stat-value" id="criticalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üì¶ Total Bikes</div>
                <div class="stat-value" id="bikesNeeded">0</div>
            </div>
        </div>

        <div id="routesContainer"></div>
    </div>

<script>
/* CLOCK */
function updateClock() {
    const now = new Date();
    const text = now.toLocaleString("en-GB", { 
        day:"2-digit", month:"2-digit", year:"numeric",
        hour:"2-digit", minute:"2-digit"
    }).replace(",", "");
    document.getElementById("clock").textContent = text;
}
setInterval(updateClock, 1000);
updateClock();

/* CSV DROPZONE */
let hubsData = [];

const dropzone = document.getElementById("csvDropzone");
const csvInput = document.getElementById("csvInput");

dropzone.onclick = () => csvInput.click();

dropzone.addEventListener("dragover", e => {
    e.preventDefault();
    dropzone.classList.add("dragover");
});
dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
dropzone.addEventListener("drop", e => {
    e.preventDefault();
    dropzone.classList.remove("dragover");
    parseCSV(e.dataTransfer.files[0]);
});
csvInput.onchange = () => parseCSV(csvInput.files[0]);

function parseCSV(file) {
    const reader = new FileReader();
    reader.onload = e => {
        const lines = e.target.result.split("\n").map(l => l.trim()).filter(Boolean);
        hubsData = lines.slice(1).map(row => {
            const c = row.split(",");
            return {
                name: c[0], location: c[1],
                dayAvg: Number(c[2]), eveningAvg: Number(c[3]),
                capacity: Number(c[4]), last30DayAvg: Number(c[5]),
                revenueRank: Number(c[6])
            };
        });
        updateDashboard();
    };
    reader.readAsText(file);
}

/* DASHBOARD */
function getRevenueCategory(rank) {
    if (rank <= 5) return "VIP";
    if (rank <= 12) return "HIGH";
    if (rank <= 20) return "MEDIUM";
    return "LOW";
}

function updateDashboard() {
    if (!hubsData.length) {
        document.getElementById("routesContainer").innerHTML =
            "<p style='padding:20px;'>üìÇ Upload a CSV to begin.</p>";
        return;
    }

    const shift = document.getElementById("shiftSelect").value;
    const strategy = document.getElementById("strategySelect").value;

    let list = hubsData.map(h => {
        const use = shift === "morning" ? h.dayAvg : h.eveningAvg;
        const util = Math.round((use / h.capacity) * 100);
        const need = Math.max(0, h.capacity - use);
        const rev = getRevenueCategory(h.revenueRank);

        let score = 0;
        if (strategy === "revenue") score = h.last30DayAvg * 100 + util;
        else if (strategy === "critical") score = util >= 80 ? util : 0;
        else score = h.last30DayAvg * 50 + util;

        return {
            ...h, currentUsage: use,
            utilizationRate: util,
            bikesNeeded: need,
            revenueCategory: rev,
            priorityScore: score,
            urgency:
                util >= 90 ? "CRITICAL" :
                util >= 70 ? "HIGH" :
                util >= 50 ? "MEDIUM" : "LOW",
            shouldRefill:
                strategy === "critical" ? util >= 80 :
                strategy === "revenue" ? h.revenueRank <= 15 :
                util >= 60 || h.revenueRank <= 10
        };
    })
    .filter(h => h.shouldRefill && h.bikesNeeded > 0)
    .sort((a, b) => b.priorityScore - a.priorityScore);

    /* Route logic 50‚Äì54 bikes optimal, target 52 */
    const MIN = 50, OPT = 52, MAX = 54;

    const routes = [];
    let current = [];
    let count = 0;

    for (const h of list) {
        const tooManyBikes = count + h.bikesNeeded > MAX;
        const tooManyHubs = current.length >= 5;

        if (tooManyBikes || tooManyHubs) {
            if (current.length) routes.push([...current]);
            current = [h];
            count = h.bikesNeeded;
        } else {
            current.push(h);
            count += h.bikesNeeded;
        }
    }
    if (current.length) routes.push(current);

    /* Stats */
    document.getElementById("vipHubs").textContent = list.filter(h => h.revenueCategory === "VIP").length;
    document.getElementById("needRefill").textContent = list.length;
    document.getElementById("criticalCount").textContent = list.filter(h => h.urgency === "CRITICAL").length;
    document.getElementById("bikesNeeded").textContent = list.reduce((a,b)=>a+b.bikesNeeded,0);
    document.getElementById("driversNeeded").textContent = routes.length;

    const container = document.getElementById("routesContainer");
    container.innerHTML = "";

    routes.forEach((route, i) => {
        const total = route.reduce((a,b)=>a+b.bikesNeeded,0);
        let warn = "";
        if (total < MIN) warn = `<span class='under'>‚ö† Under (${total})</span>`;
        else if (total > MAX) warn = `<span class='over'>‚ö† Over (${total})</span>`;
        else warn = `<span style="color:#059669;font-weight:bold">‚úì Optimal (${total}/52)</span>`;

        let html = `
            <div class="route-header">
                <h3>üöó Driver ${i+1} ‚Äî ${route.length} hubs ‚Äî ${warn}</h3>
            </div>
            <table><tbody>
        `;

        route.forEach((h, idx) => {
            html += `
                <tr>
                    <td>${idx+1}</td>
                    <td>${h.revenueCategory}</td>
                    <td>${h.name}</td>
                    <td>${h.location}</td>
                    <td>${h.last30DayAvg}</td>
                    <td>${h.currentUsage}</td>
                    <td>${h.capacity}</td>
                    <td>${h.utilizationRate}%</td>
                    <td style="color:#059669">+${h.bikesNeeded}</td>
                    <td>${h.urgency}</td>
                </tr>
            `;
        });

        html += "</tbody></table>";
        container.innerHTML += html;
    });
}

</script>
</body>
</html>
