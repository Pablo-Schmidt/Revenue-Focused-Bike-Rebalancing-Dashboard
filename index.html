<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Revenue-Focused Bike Rebalancing Dashboard</title>

<style>
/* ---------- (same styling you already had) ---------- */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    background: #f3f4f6;
    padding: 20px;
}
.container { max-width: 1400px; margin: 0 auto; }

.header {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    padding: 30px; border-radius: 12px; color: white;
    margin-bottom: 20px; box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    display: flex; justify-content: space-between; align-items: center;
}
#clock { font-size: 28px; font-weight: bold; color: #ff1a1a; }

.controls {
    background: white; padding: 25px; border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;
}
.control-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}
label { font-weight: 600; margin-bottom: 8px; color: #374151; display: block; }
select, input[type="text"] {
    width: 100%; padding: 10px; border: 1px solid #d1d5db;
    border-radius: 8px; font-size: 14px;
}

/* dropzone */
#dropzone {
    border: 2px dashed #3b82f6; padding: 25px; text-align: center;
    border-radius: 10px; background: #f8fafc; cursor: pointer;
    color: #1e40af; font-weight: bold; margin-bottom: 20px;
}
#dropzone.dragover { background: #dbeafe; }

/* stats */
.stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px; margin-bottom: 20px;
}
.stat-card {
    background: white; padding: 20px; border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.stat-label { color: #6b7280; font-size: 14px; margin-bottom: 5px; }
.stat-value { font-size: 32px; font-weight: bold; color: #1f2937; }

.route-header {
    background: white; padding: 20px; border-radius: 10px;
    margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
table {
    width: 100%; background: white; border-radius: 10px;
    overflow: hidden; margin-bottom: 20px;
}
th {
    background: #f9fafb; padding: 12px; text-align: left;
    border-bottom: 2px solid #e5e7eb;
}
td {
    padding: 12px; border-bottom: 1px solid #f3f4f6;
}
tr:hover { background: #f9fafb; }

.revenue-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; }
.revenue-vip { background: #fef3c7; color: #92400e; }
.revenue-high { background: #dbeafe; color: #1e40af; }
.revenue-medium { background: #e0e7ff; color: #4338ca; }
.revenue-low { background: #f3f4f6; color: #6b7280; }
</style>
</head>

<body>
<div class="container">

<!-- HEADER -->
<div class="header">
    <div>
        <h1>üí∞ Revenue-Focused Bike Rebalancing Dashboard</h1>
        <p>Prioritize high-traffic hubs to maximize trips and profits</p>
    </div>
    <div id="clock">00:00</div>
</div>

<!-- CSV LOADER -->
<div id="dropzone">üì• Drop CSV file here or click to upload</div>

<div class="controls">
    <label>üìÑ Load Google Sheet (public link)</label>
    <input type="text" id="sheetURL" placeholder="Paste Google Sheet link here...">
    <button onclick="loadGoogleSheet()" style="margin-top:10px;padding:10px 20px;">Load Sheet</button>
</div>

<!-- MAIN CONTROLS -->
<div class="controls">
    <div class="control-grid">
        <div>
            <label>üïê Shift Time</label>
            <select id="shiftSelect" onchange="updateDashboard()">
                <option value="morning">Morning Shift (Day Usage)</option>
                <option value="evening">Evening Shift (Night Usage)</option>
            </select>
        </div>

        <div>
            <label>üìä Priority Strategy</label>
            <select id="strategySelect" onchange="updateDashboard()">
                <option value="revenue">Revenue Focus</option>
                <option value="critical">Critical Only</option>
                <option value="balanced">Balanced</option>
            </select>
        </div>

        <div class="stat-card">
            <div class="stat-label">Drivers Needed</div>
            <div class="stat-value" id="driversNeeded">0</div>
        </div>
    </div>
</div>

<!-- STATS -->
<div class="stats-grid">
    <div class="stat-card"><div class="stat-label">‚≠ê VIP Hubs</div><div class="stat-value" id="vipHubs">0</div></div>
    <div class="stat-card"><div class="stat-label">üö¥ Total Hubs to Refill</div><div class="stat-value" id="needRefill">0</div></div>
    <div class="stat-card"><div class="stat-label">üî• Critical Hubs</div><div class="stat-value" id="criticalCount">0</div></div>
    <div class="stat-card"><div class="stat-label">üì¶ Total Bikes Needed</div><div class="stat-value" id="bikesNeeded">0</div></div>
</div>

<div id="routesContainer"></div>

</div>

<script>
/* -------- CLOCK -------- */
function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent =
        now.toLocaleDateString() + " " +
        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
setInterval(updateClock, 1000); updateClock();

/* ------------ CSV PARSER (SAFE) ------------- */
function parseCSV(csv) {
    const rows = [];
    let cur = "", row = [], inQuotes = false;

    for (let char of csv) {
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
            row.push(cur.trim());
            cur = "";
        } else if ((char === "\n" || char === "\r") && !inQuotes) {
            if (cur.length > 0 || row.length > 0) {
                row.push(cur.trim());
                rows.push(row);
                row = [];
                cur = "";
            }
        } else {
            cur += char;
        }
    }
    if (cur.length > 0) row.push(cur.trim());
    if (row.length > 0) rows.push(row);
    return rows;
}

/* ------------ GLOBAL DATA ------------ */
let hubsData = [];

/* ------------ FILE INPUT ------------ */
document.getElementById("dropzone").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv";
    input.onchange = e => loadCSVFile(e.target.files[0]);
    input.click();
};

document.getElementById("dropzone").addEventListener("dragover", e => {
    e.preventDefault(); e.target.classList.add("dragover");
});
document.getElementById("dropzone").addEventListener("dragleave", e => {
    e.target.classList.remove("dragover");
});
document.getElementById("dropzone").addEventListener("drop", e => {
    e.preventDefault();
    e.target.classList.remove("dragover");
    loadCSVFile(e.dataTransfer.files[0]);
});

/* ------------ HANDLE CSV FILE ------------ */
function loadCSVFile(file) {
    const reader = new FileReader();
    reader.onload = e => processCSV(e.target.result);
    reader.readAsText(file);
}

/* ------------ PROCESS CSV TEXT ------------ */
function processCSV(csvText) {
    const rows = parseCSV(csvText);
    const headers = rows.shift();

    hubsData = rows.map(r => ({
        name: r[0],
        location: r[1],
        dayAvg: Number(r[2]),
        eveningAvg: Number(r[3]),
        capacity: Number(r[4]),
        last30DayAvg: Number(r[5]),
        revenueRank: Number(r[6])
    }));

    updateDashboard();
}

/* ------------ GOOGLE SHEET LOADER ------------ */
async function loadGoogleSheet() {
    let url = document.getElementById("sheetURL").value.trim();

    if (!url.includes("docs.google.com")) {
        alert("Please paste a valid Google Sheet public link.");
        return;
    }

    const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    if (!match) {
        alert("Could not extract Sheet ID. Check your URL.");
        return;
    }

    const sheetID = match[1];
    const csvURL = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv`;

    const response = await fetch(csvURL);
    const text = await response.text();

    processCSV(text);
}

/* --------- HELPER -------- */
function getRevenueCategory(rank) {
    if (rank <= 5) return "VIP";
    if (rank <= 12) return "HIGH";
    if (rank <= 20) return "MEDIUM";
    return "LOW";
}

/* ---------- UPDATE DASHBOARD ---------- */
function updateDashboard() {
    if (hubsData.length === 0) return;

    const shift = document.getElementById("shiftSelect").value;

    let hubsToShow = hubsData.map(hub => {
        const currentUsage = shift === "morning" ? hub.dayAvg : hub.eveningAvg;
        const utilizationRate = Math.round((currentUsage / hub.capacity) * 100);
        const bikesNeeded = Math.max(0, hub.capacity - currentUsage);
        const revenueCategory = getRevenueCategory(hub.revenueRank);
        const priorityScore = hub.last30DayAvg * 100 + utilizationRate;

        return {
            ...hub,
            currentUsage,
            utilizationRate,
            bikesNeeded,
            priorityScore,
            revenueCategory,
            shouldRefill: bikesNeeded > 0
        };
    })
    .filter(h => h.shouldRefill)
    .sort((a, b) => b.priorityScore - a.priorityScore);

    /* ------- ROUTE OPTIMIZATION ------- */
    const OPTIMAL = 52;
    const MIN = 50;
    const MAX = 54;

    const routes = [];
    let current = [], load = 0;

    hubsToShow.forEach(h => {
        if (load + h.bikesNeeded > OPTIMAL && load >= MIN) {
            routes.push([...current]); current = []; load = 0;
        }
        current.push(h); load += h.bikesNeeded;

        if (load >= MAX) {
            routes.push([...current]); current = []; load = 0;
        }
    });

    if (current.length > 0) routes.push(current);

    document.getElementById("driversNeeded").textContent = routes.length;
    document.getElementById("vipHubs").textContent = hubsToShow.filter(h => h.revenueCategory === "VIP").length;
    document.getElementById("needRefill").textContent = hubsToShow.length;
    document.getElementById("criticalCount").textContent = hubsToShow.filter(h => h.utilizationRate >= 90).length;
    document.getElementById("bikesNeeded").textContent = hubsToShow.reduce((s, h) => s + h.bikesNeeded, 0);

    renderRoutes(routes);
}

/* -------- RENDER ROUTES -------- */
function renderRoutes(routes) {
    const container = document.getElementById("routesContainer");
    container.innerHTML = "";

    if (routes.length === 0) {
        container.innerHTML = "<h3>All hubs balanced!</h3>";
        return;
    }

    routes.forEach((route, i) => {
        const total = route.reduce((s, h) => s + h.bikesNeeded, 0);
        let status = total < 50 ? "‚ö†Ô∏è Too Few (<50)" :
                     total > 54 ? "‚ö†Ô∏è Too Many (>54)" :
                     "‚úì Optimal (52)";

        let html = `
            <div class="route-header">
                <h3>üöó Driver ${i + 1} ‚Äî ${total} bikes (${status})</h3>
            </div>
            <table>
            <thead>
                <tr>
                    <th>#</th><th>Tier</th><th>Name</th><th>Loc</th>
                    <th>30d</th><th>Now</th><th>Cap</th><th>%</th><th>Bikes</th>
                </tr>
            </thead>
            <tbody>
        `;

        route.forEach((hub, idx) => {
            const badge =
                hub.revenueCategory === "VIP" ? "revenue-vip" :
                hub.revenueCategory === "HIGH" ? "revenue-high" :
                hub.revenueCategory === "MEDIUM" ? "revenue-medium" :
                "revenue-low";

            html += `
                <tr>
                    <td>${idx + 1}</td>
                    <td><span class="revenue-badge ${badge}">${hub.revenueCategory}</span></td>
                    <td>${hub.name}</td>
                    <td>${hub.location}</td>
                    <td>${hub.last30DayAvg}</td>
                    <td>${hub.currentUsage}</td>
                    <td>${hub.capacity}</td>
                    <td>${hub.utilizationRate}%</td>
                    <td>${hub.bikesNeeded}</td>
                </tr>
            `;
        });

        html += "</tbody></table>";
        container.innerHTML += html;
    });
}
</script>

</body>
</html>
