<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Revenue-Focused Bike Rebalancing Dashboard</title>

<style>
/* ---------- GLOBAL RESET ---------- */
* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    background: #f3f4f6;
    padding: 20px;
    min-height: 100vh;
}

.container { 
    max-width: 1600px; 
    margin: 0 auto; 
}

/* ---------- HEADER ---------- */
.header {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    padding: 30px; 
    border-radius: 12px; 
    color: white;
    margin-bottom: 20px; 
    box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    display: flex; 
    justify-content: space-between; 
    align-items: center;
}

.header h1 {
    font-size: 28px;
    margin-bottom: 8px;
}

.header p {
    font-size: 16px;
    opacity: 0.9;
}

#clock { 
    font-size: 28px; 
    font-weight: bold; 
    color: #fbbf24;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* ---------- CONTROLS ---------- */
.controls {
    background: white; 
    padding: 25px; 
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    margin-bottom: 20px;
}

.control-grid {
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

label { 
    font-weight: 600; 
    margin-bottom: 8px; 
    color: #374151; 
    display: block;
    font-size: 14px;
}

select, input[type="text"], input[type="number"] {
    width: 100%; 
    padding: 10px; 
    border: 1px solid #d1d5db;
    border-radius: 8px; 
    font-size: 14px;
    background: white;
    transition: border-color 0.2s;
}

select:focus, input[type="text"]:focus, input[type="number"]:focus {
    outline: none;
    border-color: #3b82f6;
}

button {
    padding: 10px 20px;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: background 0.2s;
}

button:hover {
    background: #2563eb;
}

button:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.hint-text {
    margin-top: 8px;
    font-size: 12px;
    color: #6b7280;
    line-height: 1.5;
}

/* ---------- DROPZONE ---------- */
#dropzone {
    border: 2px dashed #3b82f6; 
    padding: 30px; 
    text-align: center;
    border-radius: 10px; 
    background: #f8fafc; 
    cursor: pointer;
    color: #1e40af; 
    font-weight: bold; 
    margin-bottom: 20px;
    transition: all 0.3s;
}

#dropzone:hover {
    background: #eff6ff;
    border-color: #2563eb;
}

#dropzone.dragover { 
    background: #dbeafe;
    border-color: #1e40af;
    transform: scale(1.02);
}

/* ---------- STATS GRID ---------- */
.stats-grid {
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px; 
    margin-bottom: 20px;
}

.stat-card {
    background: white; 
    padding: 20px; 
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-label { 
    color: #6b7280; 
    font-size: 13px; 
    margin-bottom: 8px;
    font-weight: 500;
}

.stat-value { 
    font-size: 28px; 
    font-weight: bold; 
    color: #1f2937;
}

/* ---------- ROUTE DISPLAY ---------- */
.route-header {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    padding: 20px; 
    border-radius: 10px;
    margin-bottom: 10px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    color: white;
}

.route-header h3 {
    font-size: 20px;
    margin-bottom: 5px;
}

.route-header p {
    font-size: 14px;
    opacity: 0.9;
}

/* ---------- TABLES ---------- */
table {
    width: 100%; 
    background: white; 
    border-radius: 10px;
    overflow: hidden; 
    margin-bottom: 25px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

th {
    background: #f9fafb; 
    padding: 12px 10px; 
    text-align: left;
    border-bottom: 2px solid #e5e7eb;
    font-weight: 600;
    color: #374151;
    font-size: 12px;
    white-space: nowrap;
}

td {
    padding: 12px 10px; 
    border-bottom: 1px solid #f3f4f6;
    font-size: 13px;
    color: #1f2937;
}

tr:hover { 
    background: #f9fafb; 
}

tr:last-child td {
    border-bottom: none;
}

/* ---------- REVENUE BADGES ---------- */
.revenue-badge { 
    padding: 4px 10px; 
    border-radius: 20px; 
    font-size: 11px;
    font-weight: 600;
    display: inline-block;
}

.revenue-vip { 
    background: #fef3c7; 
    color: #92400e; 
}

.revenue-high { 
    background: #dbeafe; 
    color: #1e40af; 
}

.revenue-medium { 
    background: #e0e7ff; 
    color: #4338ca; 
}

.revenue-low { 
    background: #f3f4f6; 
    color: #6b7280; 
}

/* ---------- COORDINATES ---------- */
.coordinates {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #6b7280;
}

/* ---------- EMPTY STATE ---------- */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.empty-state h3 {
    font-size: 24px;
    color: #10b981;
    margin-bottom: 10px;
}

.empty-state p {
    color: #6b7280;
    font-size: 16px;
}

/* ---------- RESPONSIVE ---------- */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .control-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    table {
        font-size: 11px;
    }
    
    th, td {
        padding: 8px 6px;
    }
}
</style>
</head>

<body>
<div class="container">

<!-- HEADER -->
<div class="header">
    <div>
        <h1>üí∞ Revenue-Focused Bike Rebalancing Dashboard</h1>
        <p>Select top revenue hotspots for optimal shift planning (1-3 drivers, 5-7 hubs each)</p>
    </div>
    <div id="clock">00:00</div>
</div>

<!-- CSV DROPZONE -->
<div id="dropzone">
    üì• Drop CSV file here or click to upload
</div>

<!-- GOOGLE SHEET LOADER -->
<div class="controls">
    <label>üìÑ Load Google Sheet (public link)</label>
    <input type="text" id="sheetURL" placeholder="Paste Google Sheet link here...">
    <button onclick="loadGoogleSheet()">Load Sheet</button>
    <p class="hint-text">
        ‚ìò Make sure the sheet is set to "Anyone with the link can view"<br>
        Expected columns: Hub Name, Location, Latitude, Longitude, Area, Day Avg, Evening Avg, Capacity, 30d Avg, Revenue Rank
    </p>
</div>

<!-- MAIN CONTROLS -->
<div class="controls">
    <div class="control-grid">
        <div>
            <label>üïê Shift Time</label>
            <select id="shiftSelect" onchange="updateDashboard()">
                <option value="morning">Morning Shift (Day Usage)</option>
                <option value="evening">Evening Shift (Night Usage)</option>
            </select>
        </div>

        <div>
            <label>üöó Number of Drivers</label>
            <select id="driversCount" onchange="updateDashboard()">
                <option value="1">1 Driver</option>
                <option value="2">2 Drivers</option>
                <option value="3">3 Drivers</option>
            </select>
        </div>

        <div>
            <label>üìç Hubs per Driver</label>
            <input type="number" id="hubsPerDriver" value="5" min="5" max="7" onchange="updateDashboard()">
            <p class="hint-text">Ideal: 5 hubs, Max: 7 hubs</p>
        </div>

        <div>
            <label>üìä Priority Strategy</label>
            <select id="strategySelect" onchange="updateDashboard()">
                <option value="revenue">Revenue Rank Priority</option>
                <option value="hotspot">30-Day Hotspot Priority</option>
                <option value="critical">Critical Utilization</option>
            </select>
        </div>
    </div>
</div>

<!-- STATISTICS CARDS -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">üöó Active Drivers</div>
        <div class="stat-value" id="activeDrivers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üìç Total Hubs</div>
        <div class="stat-value" id="totalHubs">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">‚≠ê VIP Hubs</div>
        <div class="stat-value" id="vipHubs">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üìà Avg 30d Trips</div>
        <div class="stat-value" id="avgHotspot">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üö¥ Bikes to Deploy</div>
        <div class="stat-value" id="bikesNeeded">0</div>
    </div>
</div>

<!-- ROUTES CONTAINER -->
<div id="routesContainer"></div>

</div>

<script>
/* =====================================
   CLOCK FUNCTIONALITY
   ===================================== */
function updateClock() {
    const now = new Date();
    const date = now.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    const time = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true
    });
    document.getElementById("clock").textContent = `${date} ${time}`;
}
setInterval(updateClock, 1000);
updateClock();

/* =====================================
   CSV PARSER (MANUAL, SAFE)
   ===================================== */
function parseCSV(csv) {
    const rows = [];
    let currentField = "";
    let currentRow = [];
    let inQuotes = false;

    for (let i = 0; i < csv.length; i++) {
        const char = csv[i];
        const nextChar = csv[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                currentField += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === "," && !inQuotes) {
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((char === "\n" || char === "\r") && !inQuotes) {
            if (char === "\r" && nextChar === "\n") {
                i++;
            }
            if (currentField.length > 0 || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(field => field.length > 0)) {
                    rows.push(currentRow);
                }
                currentRow = [];
                currentField = "";
            }
        } else {
            currentField += char;
        }
    }

    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(field => field.length > 0)) {
            rows.push(currentRow);
        }
    }

    return rows;
}

/* =====================================
   GLOBAL DATA STORAGE
   ===================================== */
let hubsData = [];

/* =====================================
   FILE UPLOAD HANDLERS
   ===================================== */
document.getElementById("dropzone").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv";
    input.onchange = e => {
        if (e.target.files[0]) {
            loadCSVFile(e.target.files[0]);
        }
    };
    input.click();
};

document.getElementById("dropzone").addEventListener("dragover", e => {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.add("dragover");
});

document.getElementById("dropzone").addEventListener("dragleave", e => {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove("dragover");
});

document.getElementById("dropzone").addEventListener("drop", e => {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove("dragover");
    
    if (e.dataTransfer.files.length > 0) {
        loadCSVFile(e.dataTransfer.files[0]);
    }
});

/* =====================================
   LOAD CSV FILE
   ===================================== */
function loadCSVFile(file) {
    if (!file) {
        alert("No file selected");
        return;
    }

    if (!file.name.endsWith('.csv')) {
        alert("Please select a CSV file");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        try {
            processCSV(e.target.result);
        } catch (error) {
            console.error("Error processing CSV:", error);
            alert("Error processing CSV file. Please check the format.");
        }
    };
    reader.onerror = () => {
        alert("Error reading file");
    };
    reader.readAsText(file);
}

/* =====================================
   PROCESS CSV TEXT
   ===================================== */
function processCSV(csvText) {
    const rows = parseCSV(csvText);
    
    if (rows.length < 2) {
        alert("CSV file appears to be empty or invalid");
        return;
    }

    const headers = rows[0];
    const dataRows = rows.slice(1);

    // Parse data rows - now expecting 10 columns
    hubsData = dataRows
        .filter(row => row.length >= 10 && row[0].trim().length > 0)
        .map(row => ({
            name: row[0] || "Unknown",
            location: row[1] || "Unknown",
            latitude: row[2] || "",
            longitude: row[3] || "",
            area: row[4] || "Unknown Area",
            dayAvg: Number(row[5]) || 0,
            eveningAvg: Number(row[6]) || 0,
            capacity: Number(row[7]) || 50,
            last30DayAvg: Number(row[8]) || 0,
            revenueRank: Number(row[9]) || 999
        }));

    if (hubsData.length === 0) {
        alert("No valid data found in CSV");
        return;
    }

    console.log(`Loaded ${hubsData.length} hubs`);
    updateDashboard();
}

/* =====================================
   GOOGLE SHEET LOADER
   ===================================== */
async function loadGoogleSheet() {
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = "Loading...";
    btn.disabled = true;

    try {
        let url = document.getElementById("sheetURL").value.trim();

        if (!url) {
            alert("Please paste a Google Sheet URL");
            return;
        }

        if (!url.includes("docs.google.com")) {
            alert("Please paste a valid Google Sheet public link.");
            return;
        }

        const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (!match) {
            alert("Could not extract Sheet ID. Check your URL.");
            return;
        }

        const sheetID = match[1];
        const csvURL = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv`;

        console.log("Fetching:", csvURL);
        const response = await fetch(csvURL);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const text = await response.text();
        
        if (!text || text.length < 10) {
            throw new Error("Sheet appears to be empty");
        }

        processCSV(text);
        alert("‚úÖ Google Sheet loaded successfully!");
        
    } catch (error) {
        console.error("Error loading Google Sheet:", error);
        alert(
            "‚ùå Error loading sheet. Make sure:\n\n" +
            "1. The sheet is set to 'Anyone with the link can view'\n" +
            "2. You copied the full URL from the address bar\n" +
            "3. The sheet has the correct format\n\n" +
            `Error: ${error.message}`
        );
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

/* =====================================
   HELPER FUNCTIONS
   ===================================== */
function getRevenueCategory(rank) {
    if (rank <= 5) return "VIP";
    if (rank <= 12) return "HIGH";
    if (rank <= 20) return "MEDIUM";
    return "LOW";
}

function getRevenueBadgeClass(category) {
    switch(category) {
        case "VIP": return "revenue-vip";
        case "HIGH": return "revenue-high";
        case "MEDIUM": return "revenue-medium";
        default: return "revenue-low";
    }
}

/* =====================================
   UPDATE DASHBOARD
   ===================================== */
function updateDashboard() {
    if (hubsData.length === 0) {
        console.log("No data to display");
        return;
    }

    const shift = document.getElementById("shiftSelect").value;
    const strategy = document.getElementById("strategySelect").value;
    const driversCount = Number(document.getElementById("driversCount").value);
    const hubsPerDriver = Number(document.getElementById("hubsPerDriver").value);
    const totalHubsNeeded = driversCount * hubsPerDriver;

    // Calculate metrics for each hub
    let hubsWithMetrics = hubsData.map(hub => {
        const currentUsage = shift === "morning" ? hub.dayAvg : hub.eveningAvg;
        const utilizationRate = Math.round((currentUsage / hub.capacity) * 100);
        const bikesNeeded = Math.max(0, hub.capacity - currentUsage);
        const revenueCategory = getRevenueCategory(hub.revenueRank);
        
        // Priority score based on strategy
        let priorityScore = 0;
        
        if (strategy === "revenue") {
            // Lower rank = higher priority
            priorityScore = (1000 - hub.revenueRank * 10) + hub.last30DayAvg;
        } else if (strategy === "hotspot") {
            // Prioritize by 30-day average trips
            priorityScore = hub.last30DayAvg * 100 + (1000 - hub.revenueRank * 5);
        } else if (strategy === "critical") {
            // Prioritize by utilization rate
            priorityScore = utilizationRate * 10 + (1000 - hub.revenueRank * 5);
        }

        return {
            ...hub,
            currentUsage,
            utilizationRate,
            bikesNeeded,
            priorityScore,
            revenueCategory,
            shouldRefill: bikesNeeded > 0
        };
    })
    .filter(h => h.shouldRefill)
    .sort((a, b) => {
        // Primary sort by revenue rank for VIP priority
        if (strategy === "revenue" && a.revenueRank !== b.revenueRank) {
            return a.revenueRank - b.revenueRank;
        }
        // Secondary sort by priority score
        return b.priorityScore - a.priorityScore;
    });

    // Select only the top hubs needed for the shift
    const selectedHubs = hubsWithMetrics.slice(0, totalHubsNeeded);

    /* =====================================
       DISTRIBUTE HUBS ACROSS DRIVERS
       ===================================== */
    const routes = [];
    for (let i = 0; i < driversCount; i++) {
        const start = i * hubsPerDriver;
        const end = start + hubsPerDriver;
        const driverHubs = selectedHubs.slice(start, end);
        
        if (driverHubs.length > 0) {
            routes.push(driverHubs);
        }
    }

    /* =====================================
       UPDATE STATISTICS
       ===================================== */
    document.getElementById("activeDrivers").textContent = routes.length;
    document.getElementById("totalHubs").textContent = selectedHubs.length;
    document.getElementById("vipHubs").textContent = 
        selectedHubs.filter(h => h.revenueCategory === "VIP").length;
    
    const avgHotspot = selectedHubs.length > 0 
        ? (selectedHubs.reduce((sum, h) => sum + h.last30DayAvg, 0) / selectedHubs.length).toFixed(1)
        : 0;
    document.getElementById("avgHotspot").textContent = avgHotspot;
    
    document.getElementById("bikesNeeded").textContent = 
        selectedHubs.reduce((sum, h) => sum + h.bikesNeeded, 0);

    // Render routes
    renderRoutes(routes);
}

/* =====================================
   RENDER ROUTES TABLE
   ===================================== */
function renderRoutes(routes) {
    const container = document.getElementById("routesContainer");
    container.innerHTML = "";

    if (routes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>‚úÖ No routes to display</h3>
                <p>Please upload data or adjust your settings.</p>
            </div>
        `;
        return;
    }

    routes.forEach((route, routeIndex) => {
        const totalBikes = route.reduce((sum, h) => sum + h.bikesNeeded, 0);
        const avgRevRank = (route.reduce((sum, h) => sum + h.revenueRank, 0) / route.length).toFixed(1);
        const avgHotspot = (route.reduce((sum, h) => sum + h.last30DayAvg, 0) / route.length).toFixed(1);

        let html = `
            <div class="route-header">
                <h3>üöó Driver ${routeIndex + 1} ‚Äî ${route.length} Hubs ‚Äî ${totalBikes} Bikes</h3>
                <p>Avg Revenue Rank: #${avgRevRank} | Avg 30d Trips: ${avgHotspot}/day</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Stop</th>
                        <th>Tier</th>
                        <th>Rank</th>
                        <th>Hub Name</th>
                        <th>Area</th>
                        <th>Location</th>
                        <th>Coordinates</th>
                        <th>30d Avg</th>
                        <th>Current</th>
                        <th>Capacity</th>
                        <th>Util %</th>
                        <th>Bikes</th>
                    </tr>
                </thead>
                <tbody>
        `;

        route.forEach((hub, stopIndex) => {
            const badgeClass = getRevenueBadgeClass(hub.revenueCategory);
            
            html += `
                <tr>
                    <td><strong>${stopIndex + 1}</strong></td>
                    <td>
                        <span class="revenue-badge ${badgeClass}">
                            ${hub.revenueCategory}
                        </span>
                    </td>
                    <td><strong>#${hub.revenueRank}</strong></td>
                    <td><strong>${hub.name}</strong></td>
                    <td>${hub.area}</td>
                    <td>${hub.location}</td>
                    <td class="coordinates">${hub.latitude}, ${hub.longitude}</td>
                    <td><strong>${hub.last30DayAvg.toFixed(1)}</strong></td>
                    <td>${hub.currentUsage}</td>
                    <td>${hub.capacity}</td>
                    <td>
                        <strong style="color: ${hub.utilizationRate >= 90 ? '#ef4444' : hub.utilizationRate >= 75 ? '#f59e0b' : '#10b981'}">
                            ${hub.utilizationRate}%
                        </strong>
                    </td>
                    <td><strong>${hub.bikesNeeded}</strong></td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>
        `;

        container.innerHTML += html;
    });
}

/* =====================================
   INITIALIZATION
   ===================================== */
console.log("Revenue-Focused Bike Rebalancing Dashboard loaded");
console.log("Waiting for CSV or Google Sheet data...");
</script>

</body>
</html>
