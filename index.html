<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bike Consumption Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #f3f4f6; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; }

.header {
    background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
    padding: 30px; border-radius: 12px; color: white; margin-bottom: 20px;
}
.header h1 { font-size: 28px; margin-bottom: 8px; }

.alert-box {
    background: #fef3c7; border-left: 4px solid #f59e0b;
    padding: 15px 20px; border-radius: 8px; margin-bottom: 20px;
}
.alert-box h3 { color: #92400e; font-size: 16px; margin-bottom: 8px; }
.alert-box ul { margin-left: 20px; color: #78350f; font-size: 14px; }

.controls { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
.control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
label { font-weight: 600; margin-bottom: 8px; color: #374151; display: block; font-size: 14px; }
select, input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
button { padding: 10px 20px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
button:hover { background: #6d28d9; }

#dropzone {
    border: 2px dashed #7c3aed; padding: 30px; text-align: center;
    border-radius: 10px; background: #faf5ff; cursor: pointer;
    color: #6d28d9; font-weight: bold; margin-bottom: 20px;
}
#dropzone:hover { background: #f3e8ff; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
.stat-card { background: white; padding: 20px; border-radius: 10px; }
.stat-label { color: #6b7280; font-size: 13px; margin-bottom: 8px; }
.stat-value { font-size: 28px; font-weight: bold; color: #1f2937; }

.route-header { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); padding: 20px; border-radius: 10px; margin-bottom: 10px; color: white; }

table { width: 100%; background: white; border-radius: 10px; overflow: hidden; margin-bottom: 25px; }
th { background: #f9fafb; padding: 12px 10px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600; font-size: 12px; }
td { padding: 12px 10px; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
tr:hover { background: #fef3c7; }

.consumption-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
.consumption-extreme { background: #fee2e2; color: #991b1b; }
.consumption-high { background: #fed7aa; color: #9a3412; }
.consumption-medium { background: #fef3c7; color: #92400e; }
.consumption-low { background: #e5e7eb; color: #6b7280; }

.empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 12px; }
</style>
</head>
<body>
<div class="container">

<div class="header">
    <h1>üìâ Bike Consumption Dashboard</h1>
    <p>Track daily bike usage and identify high-demand hotspots</p>
</div>

<div class="alert-box">
    <h3>üìã CSV Format:</h3>
    <ul>
        <li><strong>Columns:</strong> Hub_ID, Address, Latitude, Longitude, Area, Day1_Morning, Day1_Evening, Day2_Morning...</li>
        <li><strong>Auto-geocoding:</strong> Empty Area fields will be auto-detected from coordinates</li>
        <li><strong>Consumption:</strong> Calculated from bike decreases between readings</li>
    </ul>
</div>

<div id="dropzone">üì• Drop CSV here or click to upload</div>

<div class="controls">
    <label>üìÑ Google Sheet (public link)</label>
    <input type="text" id="sheetURL" placeholder="Paste Google Sheet link...">
    <button onclick="loadSheet()">Load Sheet</button>
</div>

<div class="controls">
    <div class="control-grid">
        <div>
            <label>üïê Shift Time</label>
            <select id="shiftSelect" onchange="update()">
                <option value="morning">Morning Shift</option>
                <option value="evening">Evening Shift</option>
            </select>
        </div>
        <div>
            <label>üöó Drivers</label>
            <select id="driversCount" onchange="update()">
                <option value="1">1 Driver</option>
                <option value="2">2 Drivers</option>
                <option value="3">3 Drivers</option>
            </select>
        </div>
        <div>
            <label>üìç Hubs per Driver</label>
            <input type="number" id="hubsPerDriver" value="5" min="5" max="7" onchange="update()">
        </div>
        <div>
            <label>üìä Ranking</label>
            <select id="rankingMethod" onchange="update()">
                <option value="total">Total Consumed (30d)</option>
                <option value="average">Avg Daily</option>
                <option value="trend">Recent Trend (7d)</option>
            </select>
        </div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">üöó Active Drivers</div>
        <div class="stat-value" id="activeDrivers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üìç Priority Hubs</div>
        <div class="stat-value" id="totalHubs">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üî• Hottest Hub</div>
        <div class="stat-value" id="hottestHub">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">üìâ Total Consumed</div>
        <div class="stat-value" id="totalConsumed">0</div>
    </div>
</div>

<div id="routesContainer"></div>

</div>

<script>
let hubsData = [];

// CSV Parser
function parseCSV(csv) {
    const rows = [];
    let field = "", row = [], inQuotes = false;
    for (let i = 0; i < csv.length; i++) {
        const c = csv[i], next = csv[i + 1];
        if (c === '"') {
            if (inQuotes && next === '"') { field += '"'; i++; }
            else { inQuotes = !inQuotes; }
        } else if (c === "," && !inQuotes) {
            row.push(field.trim()); field = "";
        } else if ((c === "\n" || c === "\r") && !inQuotes) {
            if (c === "\r" && next === "\n") i++;
            if (field || row.length) {
                row.push(field.trim());
                if (row.some(f => f)) rows.push(row);
                row = []; field = "";
            }
        } else { field += c; }
    }
    if (field || row.length) {
        row.push(field.trim());
        if (row.some(f => f)) rows.push(row);
    }
    return rows;
}

// Geocoding
async function getArea(lat, lng) {
    try {
        const res = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`,
            { headers: { 'User-Agent': 'BikeDashboard/1.0' } }
        );
        if (!res.ok) return null;
        const data = await res.json();
        const a = data.address || {};
        const city = a.city || a.town || a.municipality || "Copenhagen";
        const nb = a.suburb || a.neighbourhood || a.quarter || "";
        return nb ? `${city}, ${nb}` : city;
    } catch (e) { return null; }
}

// Process CSV
async function processCSV(text) {
    const rows = parseCSV(text);
    if (rows.length < 2) { alert("Empty CSV"); return; }
    
    document.getElementById("routesContainer").innerHTML = `
        <div class="empty-state"><h3>üîÑ Loading ${rows.length - 1} hubs...</h3></div>
    `;

    const hubs = [];
    for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        if (r.length < 7 || !r[1].trim()) continue;
        
        const name = r[1];
        const lat = (r[2] || "").trim().replace(/,+$/, "");
        const lng = (r[3] || "").trim().replace(/,+$/, "");
        let area = r[4] || "";
        
        if (!area || area === "Unknown Area") {
            if (lat && lng) {
                area = await getArea(lat, lng) || area;
                await new Promise(res => setTimeout(res, 1000));
            }
        }
        
        const counts = r.slice(5).map(v => Number(v) || 0);
        const cons = [];
        for (let j = 1; j < counts.length; j++) {
            const dec = counts[j - 1] - counts[j];
            if (dec > 0) cons.push(dec);
        }
        
        const total = cons.reduce((s, v) => s + v, 0);
        const avg = cons.length ? total / cons.length : 0;
        const trend = cons.slice(-7).reduce((s, v) => s + v, 0) / Math.min(cons.length, 7);
        
        hubs.push({ name, lat, lng, area, total, avg, trend, current: counts[counts.length - 1] });
    }
    
    hubsData = hubs.filter(h => h.total > 0);
    if (!hubsData.length) { alert("No consumption data found"); return; }
    update();
}

// File upload
document.getElementById("dropzone").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv";
    input.onchange = e => {
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = ev => processCSV(ev.target.result);
            reader.readAsText(e.target.files[0]);
        }
    };
    input.click();
};

// Google Sheet
async function loadSheet() {
    const url = document.getElementById("sheetURL").value.trim();
    if (!url) { alert("Paste URL"); return; }
    const m = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    if (!m) { alert("Invalid URL"); return; }
    try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${m[1]}/export?format=csv`);
        if (!res.ok) throw new Error("Failed to load");
        processCSV(await res.text());
    } catch (e) { alert("Error: " + e.message); }
}

// Update dashboard
function update() {
    if (!hubsData.length) return;
    
    const method = document.getElementById("rankingMethod").value;
    const drivers = Number(document.getElementById("driversCount").value);
    const per = Number(document.getElementById("hubsPerDriver").value);
    
    let ranked = [...hubsData];
    if (method === "total") ranked.sort((a, b) => b.total - a.total);
    else if (method === "average") ranked.sort((a, b) => b.avg - a.avg);
    else ranked.sort((a, b) => b.trend - a.trend);
    
    const selected = ranked.slice(0, drivers * per);
    const avgCons = selected.reduce((s, h) => s + h.avg, 0) / selected.length;
    
    selected.forEach(h => {
        if (h.avg >= avgCons * 2) h.cat = "EXTREME";
        else if (h.avg >= avgCons * 1.5) h.cat = "HIGH";
        else if (h.avg >= avgCons * 0.8) h.cat = "MEDIUM";
        else h.cat = "LOW";
    });
    
    const routes = [];
    for (let i = 0; i < drivers; i++) {
        const r = selected.slice(i * per, (i + 1) * per);
        if (r.length) routes.push(r);
    }
    
    document.getElementById("activeDrivers").textContent = routes.length;
    document.getElementById("totalHubs").textContent = selected.length;
    document.getElementById("hottestHub").textContent = selected[0]?.name || "-";
    document.getElementById("totalConsumed").textContent = 
        selected.reduce((s, h) => s + h.total, 0).toFixed(0);
    
    renderRoutes(routes);
}

function renderRoutes(routes) {
    const container = document.getElementById("routesContainer");
    if (!routes.length) {
        container.innerHTML = `<div class="empty-state"><h3>üìä Upload data to begin</h3></div>`;
        return;
    }
    
    let html = "";
    routes.forEach((route, i) => {
        const total = route.reduce((s, h) => s + h.total, 0);
        const avg = route.reduce((s, h) => s + h.avg, 0) / route.length;
        
        html += `
            <div class="route-header">
                <h3>üöó Driver ${i + 1} ‚Äî ${route.length} Hubs</h3>
                <p>Total: ${total.toFixed(0)} bikes | Avg: ${avg.toFixed(1)}/day</p>
            </div>
            <table><thead><tr>
                <th>Rank</th><th>Demand</th><th>Address</th><th>Area</th>
                <th>Coordinates</th><th>Total</th><th>Avg Daily</th><th>Trend</th>
            </tr></thead><tbody>`;
        
        route.forEach((h, j) => {
            const badge = h.cat === "EXTREME" ? "consumption-extreme" :
                         h.cat === "HIGH" ? "consumption-high" :
                         h.cat === "MEDIUM" ? "consumption-medium" : "consumption-low";
            html += `<tr>
                <td><strong>#${j + 1}</strong></td>
                <td><span class="consumption-badge ${badge}">${h.cat}</span></td>
                <td><strong>${h.name}</strong></td>
                <td>${h.area}</td>
                <td>${h.lat}, ${h.lng}</td>
                <td><strong>${h.total.toFixed(0)}</strong></td>
                <td><strong>${h.avg.toFixed(1)}</strong></td>
                <td><strong>${h.trend.toFixed(1)}</strong></td>
            </tr>`;
        });
        
        html += `</tbody></table>`;
    });
    
    container.innerHTML = html;
}
</script>
</body>
</html>
