<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bike Consumption Tracking Dashboard</title>

<style>
/* [ ... ALL YOUR EXISTING CSS â€” UNMODIFIED ... ] */
</style>
</head>

<body>
<div class="container">

<!-- [ ... ALL YOUR EXISTING HTML ... ] -->

</div>

<script>
/* =====================================
   CLOCK
   ===================================== */
function updateClock() {
    const now = new Date();
    const date = now.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    const time = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true
    });
    document.getElementById("clock").textContent = `${date} ${time}`;
}
setInterval(updateClock, 1000);
updateClock();

/* =====================================
   CSV PARSER
   ===================================== */
function parseCSV(csv) {
    const rows = [];
    let currentField = "";
    let currentRow = [];
    let inQuotes = false;

    for (let i = 0; i < csv.length; i++) {
        const char = csv[i];
        const nextChar = csv[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                currentField += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === "," && !inQuotes) {
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((char === "\n" || char === "\r") && !inQuotes) {
            if (char === "\r" && nextChar === "\n") i++;
            if (currentField.length > 0 || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(field => field.length > 0)) rows.push(currentRow);
                currentRow = [];
                currentField = "";
            }
        } else {
            currentField += char;
        }
    }

    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(field => field.length > 0)) rows.push(currentRow);
    }

    return rows;
}

/* =====================================
   GLOBAL DATA
   ===================================== */
let hubsData = [];

/* =====================================
   FILE UPLOAD
   ===================================== */
document.getElementById("dropzone").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv";
    input.onchange = e => {
        if (e.target.files[0]) loadCSVFile(e.target.files[0]);
    };
    input.click();
};

/* [ ... all your existing dropzone code ... ] */

function loadCSVFile(file) {
    if (!file || !file.name.endsWith('.csv')) {
        alert("Please select a CSV file");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        try {
            processCSV(e.target.result);
        } catch (error) {
            console.error("Error processing CSV:", error);
            alert("Error processing CSV file. Please check the format.");
        }
    };
    reader.onerror = () => alert("Error reading file");
    reader.readAsText(file);
}

/* =====================================
   REVERSE GEOCODING
   ===================================== */
async function getNeighborhood(lat, lng) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1`,
            { headers: { 'User-Agent': 'BikeRebalancingDashboard/1.0' } }
        );
        
        if (!response.ok) return null;
        
        const data = await response.json();
        const addr = data.address || {};
        
        const city = addr.city || addr.town || addr.municipality || "Copenhagen";
        const neighborhood = addr.suburb || addr.neighbourhood || addr.quarter || addr.district || "";
        
        return neighborhood ? `${city}, ${neighborhood}` : city;

    } catch (error) {
        console.error("Geocoding error:", error);
        return null;
    }
}

/* =====================================
   PROCESS CSV
   ===================================== */
async function processCSV(csvText) {
    const rows = parseCSV(csvText);
    
    if (rows.length < 2) {
        alert("CSV file appears to be empty or invalid");
        return;
    }

    const headers = rows[0];
    const dataRows = rows.slice(1);

    document.getElementById("routesContainer").innerHTML = `
        <div class="empty-state">
            <h3>ðŸ”„ Loading hub data...</h3>
            <p>Fetching neighborhood information for ${dataRows.length} hubs...</p>
        </div>
    `;

    const processedHubs = [];
    
    for (let i = 0; i < dataRows.length; i++) {
        const row = dataRows[i];
        if (row.length < 7 || !row[1].trim()) continue;
        
        const hubId = row[0] || "";
        const location = row[1] || "Unknown Location";
        let latitude = row[2] || "";
        let longitude = row[3] || "";

        // Clean stray commas immediately
        latitude = String(latitude).trim().replace(/,+$/, "");
        longitude = String(longitude).trim().replace(/,+$/, "");

        let area = row[4] || "";
        
        if (!area.trim()) {
            if (latitude && longitude) {
                const geocoded = await getNeighborhood(latitude, longitude);
                if (geocoded) area = geocoded;
                await new Promise(r => setTimeout(r, 1000));
            }
        }
        
        const name = location;
        const dailyCounts = row.slice(5).map(v => Number(v) || 0);

        const consumptions = [];
        for (let i = 1; i < dailyCounts.length; i++) {
            const decrease = dailyCounts[i - 1] - dailyCounts[i];
            if (decrease > 0) consumptions.push(decrease);
        }

        const totalConsumed = consumptions.reduce((a, b) => a + b, 0);
        const avgDailyConsumption = consumptions.length ? totalConsumed / consumptions.length : 0;
        const recentTrend = consumptions.slice(-7).reduce((a,b)=>a+b,0)/ (consumptions.slice(-7).length || 1);
        const currentBikes = dailyCounts[dailyCounts.length - 1] || 0;

        processedHubs.push({
            name,
            hubId,
            latitude,
            longitude,
            area,
            dailyCounts,
            consumptions,
            totalConsumed,
            avgDailyConsumption,
            recentTrend,
            currentBikes
        });
    }
    
    hubsData = processedHubs.filter(h => h.totalConsumed > 0);

    updateDashboard();
}

/* =====================================
   GOOGLE SHEET LOADER
   ===================================== */
/* [ ... unchanged ... ] */

/* =====================================
   HELPER FUNCTIONS
   ===================================== */
function getConsumptionCategory(consumption, avgConsumption) {
    if (consumption >= avgConsumption * 2) return "EXTREME";
    if (consumption >= avgConsumption * 1.5) return "HIGH";
    if (consumption >= avgConsumption * 0.8) return "MEDIUM";
    return "LOW";
}

function getConsumptionBadgeClass(category) {
    switch(category) {
        case "EXTREME": return "consumption-extreme";
        case "HIGH": return "consumption-high";
        case "MEDIUM": return "consumption-medium";
        default: return "consumption-low";
    }
}

/* ------------- FIX ADDED HERE ------------- */
function cleanCoord(value) {
    return String(value).trim().replace(/,+$/, "");
}
/* ------------------------------------------ */

/* =====================================
   UPDATE DASHBOARD
   ===================================== */
/* [ ... unchanged ... ] */

/* =====================================
   RENDER ROUTES
   ===================================== */
function renderRoutes(routes) {
    const container = document.getElementById("routesContainer");
    container.innerHTML = "";

    if (routes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>ðŸ“Š No routes to display</h3>
                <p>Please upload consumption data to see priority hubs.</p>
            </div>
        `;
        return;
    }

    routes.forEach((route, routeIndex) => {

        let html = `
            <div class="route-header">
                <h3>ðŸš— Driver ${routeIndex + 1} â€” ${route.length} High-Demand Hubs</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Demand</th>
                        <th>Address</th>
                        <th>Area</th>
                        <th>Coordinates</th>
                        <th>Total Consumed (30d)</th>
                        <th>Avg Daily</th>
                        <th>Recent Trend</th>
                        <th>Current Bikes</th>
                    </tr>
                </thead>
                <tbody>
        `;

        route.forEach((hub, stopIndex) => {
            const badgeClass = getConsumptionBadgeClass(hub.consumptionCategory);

            html += `
                <tr>
                    <td><strong>#${stopIndex + 1}</strong></td>
                    <td><span class="consumption-badge ${badgeClass}">${hub.consumptionCategory}</span></td>
                    <td><strong>${hub.name}</strong></td>
                    <td>${hub.area}</td>
                    <td class="coordinates">${cleanCoord(hub.latitude)}, ${cleanCoord(hub.longitude)}</td>
                    <td><strong>${hub.totalConsumed}</strong> bikes</td>
                    <td><strong>${hub.avgDailyConsumption.toFixed(1)}</strong></td>
                    <td><strong>${hub.recentTrend.toFixed(1)}</strong></td>
                    <td>${hub.currentBikes}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        container.innerHTML += html;
    });
}

console.log("Bike Dashboard Loaded");
</script>
</body>
</html>
